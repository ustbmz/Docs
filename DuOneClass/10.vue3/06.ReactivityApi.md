
# è·å–å“åº”å¼æ•°æ®

> reactivity api: https://v3.vuejs.org/api/reactivity-api

| API        | ä¼ å…¥                      | è¿”å›             | å¤‡æ³¨                                                         |
| :--------- | ------------------------- | ---------------- | ------------------------------------------------------------ |
| `reactive` | `plain-object`            | `å¯¹è±¡ä»£ç†`       | æ·±åº¦ä»£ç†å¯¹è±¡ä¸­çš„æ‰€æœ‰æˆå‘˜                                     |
| `readonly` | `plain-object` or `proxy` | `å¯¹è±¡ä»£ç†`       | åªèƒ½è¯»å–ä»£ç†å¯¹è±¡ä¸­çš„æˆå‘˜ï¼Œä¸å¯ä¿®æ”¹                           |
| `ref`      | `any`                     | `{ value: ... }` | å¯¹valueçš„è®¿é—®æ˜¯å“åº”å¼çš„<br />å¦‚æœç»™valueçš„å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œ<br />åˆ™ä¼šé€šè¿‡`reactive`å‡½æ•°è¿›è¡Œä»£ç†<br />å¦‚æœå·²ç»æ˜¯ä»£ç†ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ä»£ç† |
| `computed` | `function`                | `{ value: ... }` | å½“è¯»å–valueå€¼æ—¶ï¼Œ<br />ä¼š**æ ¹æ®æƒ…å†µ**å†³å®šæ˜¯å¦è¦è¿è¡Œå‡½æ•°      |

åº”ç”¨ï¼š

- å¦‚æœæƒ³è¦è®©ä¸€ä¸ªå¯¹è±¡å˜ä¸ºå“åº”å¼æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨`reactive`æˆ–`ref`
- å¦‚æœæƒ³è¦è®©ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§åªè¯»ï¼Œä½¿ç”¨`readonly`
- å¦‚æœæƒ³è¦è®©ä¸€ä¸ªéå¯¹è±¡æ•°æ®å˜ä¸ºå“åº”å¼æ•°æ®ï¼Œä½¿ç”¨`ref`
- å¦‚æœæƒ³è¦æ ¹æ®å·²çŸ¥çš„å“åº”å¼æ•°æ®å¾—åˆ°ä¸€ä¸ªæ–°çš„å“åº”å¼æ•°æ®ï¼Œä½¿ç”¨`computed`

ç¬”è¯•é¢˜1ï¼šä¸‹é¢çš„ä»£ç è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ

```js
import { reactive, readonly, ref, computed } from "vue";

const state = reactive({
  firstName: "Xu Ming",
  lastName: "Deng",
});
const fullName = computed(() => {
  console.log("changed");
  return `${state.lastName}, ${state.firstName}`;
});
console.log("state ready");
console.log("fullname is", fullName.value);
console.log("fullname is", fullName.value);
const imState = readonly(state);
console.log(imState === state);

const stateRef = ref(state);
console.log(stateRef.value === state);

state.firstName = "Cheng";
state.lastName = "Ji";

console.log(imState.firstName, imState.lastName);
console.log("fullname is", fullName.value);
console.log("fullname is", fullName.value);

const imState2 = readonly(stateRef);
console.log(imState2.value === stateRef.value);

```

ç¬”è¯•é¢˜2ï¼šæŒ‰ç…§ä¸‹é¢çš„è¦æ±‚å®Œæˆå‡½æ•°

```js
function useUser(){
  // åœ¨è¿™é‡Œè¡¥å…¨å‡½æ•°
  return {
    user, // è¿™æ˜¯ä¸€ä¸ªåªè¯»çš„ç”¨æˆ·å¯¹è±¡ï¼Œå“åº”å¼æ•°æ®ï¼Œé»˜è®¤ä¸ºä¸€ä¸ªç©ºå¯¹è±¡
    setUserName, // è¿™æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼ å…¥ç”¨æˆ·å§“åï¼Œç”¨äºä¿®æ”¹ç”¨æˆ·çš„åç§°
    setUserAge, // è¿™æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼ å…¥ç”¨æˆ·å¹´é¾„ï¼Œç”¨æˆ·ä¿®æ”¹ç”¨æˆ·çš„å¹´é¾„
  }
}
```

```ts
import { reactive, readonly, ref, computed } from 'vue'

function useUser() {
  const userOrign = reactive({})
  const user = readonly(userOrign)
  const setUserName = (name) => {
    userOrign.name = name
  }
  const setUserAge = (age) => {
    userOrign.age = age
  }
  return {
    user,
    setUserName,
    setUserAge,
  }
}
```





ç¬”è¯•é¢˜3ï¼šæŒ‰ç…§ä¸‹é¢çš„è¦æ±‚å®Œæˆå‡½æ•°

```js
function useDebounce(obj, duration){
  // åœ¨è¿™é‡Œè¡¥å…¨å‡½æ•°
  return {
    value, // è¿™é‡Œæ˜¯ä¸€ä¸ªåªè¯»å¯¹è±¡ï¼Œå“åº”å¼æ•°æ®ï¼Œé»˜è®¤å€¼ä¸ºå‚æ•°å€¼
    setValue // è¿™é‡Œæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼ å…¥ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œéœ€è¦æŠŠæ–°å¯¹è±¡ä¸­çš„å±æ€§æ··åˆåˆ°åŸå§‹å¯¹è±¡ä¸­ï¼Œæ··åˆæ“ä½œéœ€è¦åœ¨durationçš„æ—¶é—´ä¸­é˜²æŠ–
  }
}
```

```js
// è§£é¢˜ä»£ç 
const timeId = null

function useDebounce(obj, duration) {
  const objOrigin = reactive(obj)
  const value = readonly(objOrigin)

  const setValue = (newVal) => {
    Object.entries(newVal).forEach(([k, v]) => {
      console.log('ğŸš€ ~ Object.entries ~ newVal:', newVal)
      clearTimeout(timeId)
      setTimeout(() => {
        objOrigin[k] = v
      })
    })
  }
  return {
    value, 
    setValue, 
  }
}

const { value, setValue } = useDebounce({ a: 1, b: 2 }, 3000)
window.value = value
window.setValue = setValue
```



# ç›‘å¬æ•°æ®å˜åŒ–

**watchEffect**

```js
const stop = watchEffect(() => {
  // è¯¥å‡½æ•°ä¼šç«‹å³æ‰§è¡Œï¼Œç„¶åè¿½ä¸­å‡½æ•°ä¸­ç”¨åˆ°çš„å“åº”å¼æ•°æ®ï¼Œå“åº”å¼æ•°æ®å˜åŒ–åä¼šå†æ¬¡æ‰§è¡Œ
})

// é€šè¿‡è°ƒç”¨stopå‡½æ•°ï¼Œä¼šåœæ­¢ç›‘å¬
stop(); // åœæ­¢ç›‘å¬
```

**watch**

```js
// ç­‰æ•ˆäºvue2çš„$watch

// ç›‘å¬å•ä¸ªæ•°æ®çš„å˜åŒ–
const state = reactive({ count: 0 })
watch(() => state.count, (newValue, oldValue) => {
  // ...
}, options)

const countRef = ref(0);
watch(countRef, (newValue, oldValue) => {
  // ...
}, options)

// ç›‘å¬å¤šä¸ªæ•°æ®çš„å˜åŒ–
watch([() => state.count, countRef], ([new1, new2], [old1, old2]) => {
  // ...
});
```

**æ³¨æ„ï¼šæ— è®ºæ˜¯`watchEffect`è¿˜æ˜¯`watch`ï¼Œå½“ä¾èµ–é¡¹å˜åŒ–æ—¶ï¼Œå›è°ƒå‡½æ•°çš„è¿è¡Œéƒ½æ˜¯å¼‚æ­¥çš„ï¼ˆå¾®é˜Ÿåˆ—ï¼‰**

åº”ç”¨ï¼šé™¤éé‡åˆ°ä¸‹é¢çš„åœºæ™¯ï¼Œå¦åˆ™å‡å»ºè®®é€‰æ‹©`watchEffect`

- ä¸å¸Œæœ›å›è°ƒå‡½æ•°ä¸€å¼€å§‹å°±æ‰§è¡Œ
- æ•°æ®æ”¹å˜æ—¶ï¼Œéœ€è¦å‚è€ƒæ—§å€¼
- éœ€è¦ç›‘æ§ä¸€äº›å›è°ƒå‡½æ•°ä¸­ä¸ä¼šç”¨åˆ°çš„æ•°æ®

ç¬”è¯•é¢˜: ä¸‹é¢çš„ä»£ç è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ

```js
import { reactive, watchEffect, watch } from "vue";
const state = reactive({
  count: 0,
});
watchEffect(() => {
  console.log("watchEffect", state.count);
});
watch(
  () => state.count,
  (count, oldCount) => {
    console.log("watch", count, oldCount);
  }
);
console.log("start");
setTimeout(() => {
  console.log("time out");
  state.count++;
  state.count++;
});
state.count++;
state.count++;

console.log("end");

```



# åˆ¤æ–­

| API          | å«ä¹‰                                                         |
| ------------ | ------------------------------------------------------------ |
| `isProxy`    | åˆ¤æ–­æŸä¸ªæ•°æ®æ˜¯å¦æ˜¯ç”±`reactive`æˆ–`readonly`                   |
| `isReactive` | åˆ¤æ–­æŸä¸ªæ•°æ®æ˜¯å¦æ˜¯é€šè¿‡`reactive`åˆ›å»ºçš„<br />è¯¦ç»†:https://v3.vuejs.org/api/basic-reactivity.html#isreactive |
| `isReadonly` | åˆ¤æ–­æŸä¸ªæ•°æ®æ˜¯å¦æ˜¯é€šè¿‡`readonly`åˆ›å»ºçš„                       |
| `isRef`      | åˆ¤æ–­æŸä¸ªæ•°æ®æ˜¯å¦æ˜¯ä¸€ä¸ª`ref`å¯¹è±¡                              |



# è½¬æ¢

**unref**

ç­‰åŒäºï¼š`isRef(val) ? val.value : val`

åº”ç”¨ï¼š

```js
function useNewTodo(todos){
  todos = unref(todos);
  // ...
}
```



**toRef**

å¾—åˆ°ä¸€ä¸ªå“åº”å¼å¯¹è±¡æŸä¸ªå±æ€§çš„refæ ¼å¼

```js
const state = reactive({
  foo: 1,
  bar: 2
})

const fooRef = toRef(state, 'foo'); // fooRef: {value: ...}

fooRef.value++
console.log(state.foo) // 2

state.foo++
console.log(fooRef.value) // 3
```

**toRefs**

æŠŠä¸€ä¸ªå“åº”å¼å¯¹è±¡çš„æ‰€æœ‰å±æ€§è½¬æ¢ä¸ºrefæ ¼å¼ï¼Œç„¶ååŒ…è£…åˆ°ä¸€ä¸ª`plain-object`ä¸­è¿”å›

```js
const state = reactive({
  foo: 1,
  bar: 2
})

const stateAsRefs = toRefs(state)
/*
stateAsRefs: not a proxy
{
  foo: { value: ... },
  bar: { value: ... }
}
*/
```

åº”ç”¨ï¼š

```js
setup(){
  const state1 = reactive({a:1, b:2});
  const state2 = reactive({c:3, d:4});
  return {
    ...state1, // lost reactivity
    ...state2 // lost reactivity
  }
}

setup(){
  const state1 = reactive({a:1, b:2});
  const state2 = reactive({c:3, d:4});
  return {
    ...toRefs(state1), // reactivity
    ...toRefs(state2) // reactivity
  }
}
// composition function
function usePos(){
  const pos = reactive({x:0, y:0});
  return pos;
}

setup(){
  const {x, y} = usePos(); // lost reactivity
  const {x, y} = toRefs(usePos()); // reactivity
}
```

# é™ä½å¿ƒæ™ºè´Ÿæ‹…

æ‰€æœ‰çš„`composition function`å‡ä»¥`ref`çš„ç»“æœè¿”å›ï¼Œä»¥ä¿è¯`setup`å‡½æ•°çš„è¿”å›ç»“æœä¸­ä¸åŒ…å«`reactive`æˆ–`readonly`ç›´æ¥äº§ç”Ÿçš„æ•°æ®

```js
function usePos(){
  const pos = reactive({ x:0, y:0 });
  return toRefs(pos); //  {x: refObj, y: refObj}
}
function useBooks(){
  const books = ref([]);
  return {
    books // books is refObj
  }
}
function useLoginUser(){
  const user = readonly({
    isLogin: false,
    loginId: null
  });
  return toRefs(user); // { isLogin: refObj, loginId: refObj }  all ref is readonly
}

setup(){
  // åœ¨setupå‡½æ•°ä¸­ï¼Œå°½é‡ä¿è¯è§£æ„ã€å±•å¼€å‡ºæ¥çš„æ‰€æœ‰å“åº”å¼æ•°æ®å‡æ˜¯ref
  return {
    ...usePos(),
    ...useBooks(),
    ...useLoginUser()
  }
}
```