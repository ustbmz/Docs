# Week10_å¼€å‘ç”¨æˆ·ä¸­å¿ƒ

## ä½¿ç”¨scssè¯­æ³•å¿«é€Ÿç”Ÿæˆé€šç”¨æ ·å¼ä»£ç 

```scss
## å¿«é€Ÿç”Ÿæˆpadding æ ·å¼,å…¶ä»–åŒç†
@for $i from 0 to 5{
  .pd#{$i}{
    padding: $i * 10 + px
  }
  .mt#{$i}{
    margin-top: $i * 10 + px
  }
}
```

sassé«˜çº§è¿›é˜¶è¯­æ³•

## Vue-Router è·¯ç”±å®ˆå«

```javascript
## å•ä¸ªè·¯ç”±å®ˆå«
beforeEnter(to,from,next){
	const token = localStorage.getItem('token')
  const userInfo = JSON.parse(localStorage.getItem('userInfo'))
  if (token !== '' && token !== 'undefined') {
    store.commit('setUserInfo', userInfo)
    store.commit('setIsLogin', true)
    store.commit('setToken', token)
  }
  if (to.matched.some(record => record.meta.requiresAuth)) {
    const islogin = store.state.isLogin
    if (islogin) {
      next()
    } else {
      next('login')
    }
  } else {
    next()
  }
}

## å…¨å±€è·¯ç”±å®ˆå«
router.beforeEach((to, from, next) => {
  const token = localStorage.getItem('token')
  const userInfo = JSON.parse(localStorage.getItem('userInfo'))
  if (token !== '' && token !== 'undefined') {
    store.commit('setUserInfo', userInfo)
    store.commit('setIsLogin', true)
    store.commit('setToken', token)
  }
  if (to.matched.some(record => record.meta.requiresAuth)) {
    const islogin = store.state.isLogin
    if (islogin) {
      next()
    } else {
      next('login')
    }
  } else {
    next()
  }
})
```



### å¢å¼ºç”¨æˆ·ç™»é™†å®‰å…¨æœºåˆ¶ï¼ŒéªŒè¯tokenè¿‡æœŸæ—¶é—´

> npm install -S jsonwebtoken

```javascript
## deploy tokenæ•°æ®
jwt.deploy(token)
## ä½¿ç”¨momentæ ¡éªŒtokenæ˜¯å¦è¿‡æœŸ è¿”å› Boolean
moment().isBefore(moment(token.exp * 1000)) 
```





### ç­¾åˆ°æ¨¡å—CSSæ ·å¼å¼€å‘

TODO



### ä½¿ç”¨vueä¸­çš„syncä¿®é¥°ç¬¦ï¼Œç®€åŒ–propä¼ å‚ï¼ˆå³propsåŒå‘ç»‘å®šï¼‰

 **é—®é¢˜ï¼šåœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¯¹ä¸€ä¸ª prop è¿›è¡Œâ€œåŒå‘ç»‘å®šâ€ã€‚**

æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢ä¸€èŠ‚ä¸­çš„`SignInfo`ç»„ä»¶çš„`isShow`å±æ€§ï¼š

å­ç»„ä»¶`SignInfo`ï¼š

```vue
<script>
export default {
  name: 'sign-info',
  props: {
    isShow: {
      default: false,
      type: Boolean
    }
  },
  methods: {
    close () {
      this.$emit('closeModal')
    }
  }
}
</script>
```

çˆ¶ç»„ä»¶`Sign.vue`ï¼š

```vue
<sign-info :isShow="isShow" @closeModal="close()"></sign-info>
```

**è§£å†³åŠæ³•ï¼š**

è¿™é‡Œæœ‰ä¸€ç§ç®€åŒ–çš„å†™æ³•ï¼Œä½¿ç”¨`sync`ä¿®é¥°ç¬¦ï¼š

> Vueå®˜æ–¹å¯¹äº`sync`ä¿®é¥°ç¬¦çš„[æ–‡æ¡£](https://cn.vuejs.org/v2/guide/components-custom-events.html#sync-ä¿®é¥°ç¬¦)ã€‚

å­ç»„ä»¶`SignInfo`ï¼š

```vue
<script>
export default {
  name: 'sign-info',
  props: {
    isShow: {
      default: false,
      type: Boolean
    }
  },
  methods: {
    close () {
      this.$emit('update:isShow', false)
    }
  }
}
</script>
```

çˆ¶ç»„ä»¶`Sign.vue`ï¼š

```vue
<sign-info :isShow.sync="isShow"></sign-info>
```

ä½¿ç”¨ä¸­çš„æ³¨æ„äº‹é¡¹ï¼š

1. `.sync` ä¿®é¥°ç¬¦çš„ `v-bind` ä¸èƒ½å’Œè¡¨è¾¾å¼ä¸€èµ·ä½¿ç”¨ (ä¾‹å¦‚ `v-bind:title.sync=â€doc.title + â€˜!â€™â€` æ˜¯æ— æ•ˆçš„)
2. è®¾ç½®å¤šä¸ª `prop` çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥å°†è¿™ä¸ª`.sync` ä¿®é¥°ç¬¦å’Œ`v-bind` é…åˆä½¿ç”¨ï¼š`<text-document v-bind.sync="doc"></text-document>`





## è‡ªå®šä¹‰popæ°”æ³¡ç»„ä»¶

**pop / Pop.vue**

```vue
<template>
  <div
    class="tips animation"
    v-show="isShow"
    :class="{ shake: aniType === 'shake' }"
    ref="tips"
  >
    <div class="content">
      {{ msg }}
    </div>
  </div>
</template>

<script>
export default {
  name: "pop",
  props: {
    isShow: {
      type: Boolean,
      default: false,
    },
    msg: {
      type: String,
      default: "é»˜è®¤popå†…å®¹",
    },
    aniType: {
      type: String,
      default: "",
    },
  },
  watch: {
    // åŠ¨æ€è·å–é«˜å®½ è®¾ç½®ä½ç½® æ˜¾ç¤ºæŠ–åŠ¨æ•ˆæœ
    isShow (newval, oldval) {
      if (newval !== oldval && newval === true) {
        setTimeout(() => {
          let width = this.$refs.tips.clientWidth;
          let height = this.$refs.tips.clientHeight;
          this.$refs.tips.style.marginLeft = -width / 2 + "px";
          this.$refs.tips.style.marginTop = -height / 2 + "px";
          this.isShow = true;
        }, 0);
        setTimeout(() => {
          this.aniType = "";
          this.msg = "";
          this.isShow = false;
        }, 3000);
      }
    },
  },
};
</script>

<style lang="scss" scoped>
@keyframes shake {
  0%,
  100% {
    transform: translateX(0);
  }
  15%,
  45%,
  75% {
    transform: translateX(-10px);
  }
  30%,
  60%,
  85% {
    transform: translateX(10px);
  }
}
.animation {
  animation-duration: 0.3s;
  animation-fill-mode: both;
}
.tips {
  position: fixed;
  top: 50%;
  left: 50%;
}
.content {
  background: rgba(0, 0, 0, 0.4);
  color: #fff;
  border-radius: 8px;
  padding: 10px 15px;
}
.shake {
  animation-name: shake;
}
</style>
```

**pop / index.js**

```javascript
import PopComponent from './Pop.vue'

const Pop = {}

Pop.install = (Vue) => {
  ## æ³¨å†Œpopç»„ä»¶
  const PopConstructor = Vue.extend(PopComponent)
  const instance = new PopConstructor()
  instance.$mount(document.createElement('div'))
  document.body.appendChild(instance.$el)

  ## æ·»åŠ å®ä¾‹æ–¹æ³•ï¼Œä¾›å…¨å±€ä½¿ç”¨
  Vue.prototype.$pop = (type, msg) => {
    instance.aniType = type,
      instance.msg = msg,
      instance.isShow = true
  }
}

export default Pop
```



## è§£å†³æ ¹è·¯ç”±é‡å¤æŠ¥é”™

![image-20210623180658001](https://gitee.com/cnmz/images/raw/master/images/20210623180703.png)

```javascript
	this.$router.push("/", () => {});
```

#### é…ç½®404 Routerè·¯ç”±

```javascript
{
  path: "/404",
  component:notFound
},
{
  path: '*',
  redirect: '/404'
}
```



## API - ä½¿ç”¨koa-combine-router 

> åŠ è½½modulesæ–‡ä»¶å¤¹ä¸‹(åŒ…å«åµŒå¥—ç›®å½•)æ‰€æœ‰router.jsæ–‡ä»¶
>
> npmjs [https://www.npmjs.com/package/koa-combine-routers]

```javascript
import combineRoutes from 'koa-combine-routers'

// import demoRouter from './demoRouter'
// import loginRouter from './loginRouter'
// import userRouter from './userRouter'

// åŠ è½½ç›®å½•ä¸­ router ä¸­é—´ä»¶
const moduleFiles = require.context('./modules', true, /\.js$/)

// reduceæ–¹æ³•æ‹¼æ¥ koa-combine-router æ‰€éœ€æ•°æ®ç»“æ„
const modules = moduleFiles.keys().reduce((items, path) => {
  const value = moduleFiles(path)
  items.push(value.default)
  return items
}, [])

export default combineRoutes(modules)
```



## å¼€å‘ç”¨æˆ·å¤´åƒå›¾ç‰‡ä¸Šä¼ 

> ä¿®æ”¹api é¡¹ç›® index.js
>
> é…ç½® koa-body å±æ€§ï¼Œæ”¯æŒæ–‡ä»¶ä¸Šä¼ 

```javascript
koaBody({
  	// multipart {Boolean} Parse multipart bodies, default false
    multipart: true,
  	// formidable {Object} Options to pass to the formidable multipart parser
    formidable: {
      // keepExtensions {Boolean} Files written to uploadDir will include the extensions of the original files, default false
      keepExtensions: true,
      // maxFieldsSize {Integer} Limits the amount of memory all fields together (except files) can allocate in bytes. If this value is exceeded, an 'error' event is emitted, default 2mb (2 * 1024 * 1024)
      maxFieldsSize: 5 * 1024 * 1024
    },
  	// onError {Function} Custom error handle, if throw an error, you can customize the response - onError(error, context), default will throw
  	// å®šä¹‰é”™è¯¯å¥æŸ„ï¼Œå¦‚æœæŠ›å‡ºé”™è¯¯ï¼Œå¯ä»¥è‡ªå®šä¹‰å“åº” -onError (é”™è¯¯ï¼Œä¸Šä¸‹æ–‡) ï¼Œé»˜è®¤ä¼šæŠ›å‡º
    onError: (err) => {
      console.log('ğŸš€ ~ file: index.js ~ line 64 ~ err', err)
    }
  }),
```



> å·¥å…·ç±» Untils.js æ·»åŠ æ–‡ä»¶è¯»å–ï¼Œåˆ›å»ºæ–¹æ³• 

```javascript
## è¿”å›çš„ <fs.Stats> å¯¹è±¡ä¸­çš„æ•°å€¼æ˜¯å¦åº”ä¸º bigintã€‚ é»˜è®¤å€¼: false
## è¿”å›å¯¹è±¡æä¾›æœ‰å…³æ–‡ä»¶çš„ä¿¡æ¯ã€‚<fs.Stats> object
const getStats = async (path) => {
  return new Promise((resolve) => {
    fs.stat(path, (err, stats) => err ? resolve(false) : resolve(stats))
  })
}

## åˆ›å»ºç›®å½•
const mkdir = (dir) => {
  return new Promise((resolve) => {
    fs.mkdir(dir, err => err ? resolve(false) : resolve(true))
  })
}

## å¦‚æœä¸Šçº§ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸Šçº§ç›®å½•
const dirExists = async (dir) => {
  const isExists = await getStats(dir)
  console.log('ğŸš€ ~ file: Utils.js ~ line 44 ~ dirExist ~ isExists', isExists)
  // å¦‚æœè¯¥ç›®å½•å­˜åœ¨ï¼Œä¸”ä¸æ˜¯æ–‡ä»¶
  // isDirectory()å¯¹è±¡æè¿°æ–‡ä»¶ç³»ç»Ÿç›®å½•ï¼Œåˆ™è¿”å› true
  if (isExists && isExists.isDirectory) {
    return true
  } else if (isExists) {
    // è·¯å¾„å­˜åœ¨ï¼Œä½†æ˜¯æ˜¯æ–‡ä»¶
    return false
  }

  ## å¦‚æœè¯¥è·¯å¾„ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºè¿™ä¸ªç›®å½•
  const tempDir = path.parse(dir).dir
  const status = await dirExists(tempDir)
  if (status) {
    ## ä¸Šçº§ç›®å½•å­˜åœ¨ï¼Œåˆ›å»ºäºŒçº§ç›®å½•
    const result = mkdir(dir)
    console.log('ğŸš€ ~ file: Utils.js ~ line 57 ~ dirExist ~ result', result)
    return result
  } else {
    return false
  }
}
```

```shell
## ä½¿ç”¨make-dir npmä¾èµ–åŒ…å®ç°ä»¥ä¸ŠåŠŸèƒ½
npm install -S make-dir
```



### ä¿®æ”¹ç”¨æˆ·å¯†ç 

ä½¿ç”¨bcrypt æ ¡éªŒå¯†ç 

 ```js
 // Load hash from your password DB.
 bcrypt.compare(myPlaintextPassword, hash, function(err, result) {
     // result == true
 });
 bcrypt.compare(someOtherPlaintextPassword, hash, function(err, result) {
     // result == false
 });
 ```

