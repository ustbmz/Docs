# Week11 å¼€å‘å‘å¸– / å›å¸–æ¨¡å—

## å®Œæˆé™æ€é¡µé¢

```vue
<template>
  <div class="edit-warp">
    <div class="layui-from-item layui-form-text">
      <div class="layui-input-block">
        <div class="layui-unselect fly-edit">
          <span @click="()=>{this.faceStatus = !this.faceStatus}" ref="face"><i class="iconfont icon-yxj-expression"></i></span>
          <span><i class="iconfont icon-tupian"></i></span>
          <span><i class="iconfont icon-lianjie"></i></span>
          <span class="quote">â€</span>
          <span><i class="iconfont icon-emwdaima"></i></span>
          <span>hr</span>
          <span><i class="iconfont icon-yulan"></i></span>
        </div>
        <textarea name="content"  class="layui-textarea fly-editor"></textarea>
      </div>
      <face :isShow="faceStatus" :ctrl="this.$refs.face" @closeEvent='()=>{this.faceStatus = false}'></face>
    </div>
  </div>
</template>

<script>
  import Face from './face.vue'
  export default {
    name:'editor',
    components: {
      Face
    },
    data () {
      return {
        faceStatus:false
      }
    }
  }
</script>

<style lang="scss" scoped>
@keyframes bounceIn{
  0%{
    opacity: 0;
    transform: scale(0.5);
  }
  100%{
    opacity: 1;
    transform: scale(1);
  }
}
@keyframes bounceOut{
  0%{
    transform: scale(1);
  }
  30%{
    transform: scale(1.05);
  }
  100%{
    opacity: 0;
    transform: scale(0.7);
  }
}

.fade-leave-active{
  animation: bounceOut 0.3s;
}
.fade-enter-active,
.fade-enter-to{
  animation: bounceIn 0.3s;
}

.fly-editor{
  height: 260px;
}
.quote{
  font-size: 22px;
  vertical-align: middle;
  position: relative;
  top:4px;
}
.edit-warp{
  position: relative;
}
</style>
```

## Mixinæ··å…¥éªŒè¯ç æ¨¡å—

```js
import { getCode } from "@/api/login";
import { v4 as uuidv4 } from "uuid";

export default {
  name: "codeMix",
  components: {
  },
  data () {
    return {
      code: "",
      svg: "",
    };
  },
  mounted () {
    console.log("login mounted");
    let sid = "";
    if (localStorage.getItem("sid")) {
      sid = localStorage.getItem("sid");
    } else {
      sid = uuidv4();
      localStorage.setItem("sid", sid);
    }
    this.$store.commit("setSid", sid);
    this._getCode();
  },
  methods: {
    _getCode () {
      let sid = localStorage.getItem("sid");
      getCode(sid).then((res) => {
        if (res.code === 200) {
          this.svg = res.data;
        }
      });
    },
  },
};
```

## Vue è¿‡æ¸¡åŠ¨ç”»

![image-20210629163544366](https://gitee.com/cnmz/images/raw/master/images/20210629163544.png)

### ä½¿ç”¨ layui - face.js æ·»åŠ è¡¨æƒ…æ ·å¼åŠå¯¹åº”äº¤äº’

```vue
<template>
  <transition name="fade">
    <div class="layui-layer layui-layer-tips layui-edit-face edit-content">
      <div class="layui-layer-content" v-show="isShow">
        <ul class="layui-clear">
          <li v-for="(value,key) in list" :key="key" @click="handleFaceClick(key)">
            <img :src="value" alt>
          </li>
        </ul>
      </div>
    </div>
  </transition>
</template>

<script>
import faces from '@/assets/js/face'
  export default {
    name:'Face',
    props:['isShow','ctrl'],
    data () {
      return {
        list:faces
      }
    },
    methods: {
      handleFaceClick(item){
        this.$emit('addEvent',item)
      },
      handleBodyClick(e){
        // é˜»æ­¢äº‹ä»¶å†’æ³¡
        e.stopPropagation()
        // å¦‚æœfaceæœªæ˜¾ç¤º ï¼Œç›´æ¥return
        if(!this.isShow){return}
        console.log('ğŸš€ ~ file: face.vue ~ line 35 ~ handleBodyClick ~ e', e)
        // è§¦å‘å…³é—­æœ¬ç»„ä»¶çš„å…³é—­æ—¶é—´ï¼Œæ”¹å˜isShowçš„çŠ¶æ€
        // åˆ¤æ–­æ˜¯å¦ç‚¹å‡»ä½ç½®ä¸ºiconå¤–éƒ¨åˆ†
        if(!this.ctrl.contains(e.target)){
          this.$emit('closeEvent')
        }
      }
    },
    mounted () {
      console.log(this.ctrl);
      document.querySelector('body').addEventListener('click',this.handleBodyClick)
    },
    destroyed () {
       document.querySelector('body').removeEventListener('click',this.handleBodyClick)
    }
  }
</script>

<style lang="scss" scoped>
.edit-content{
  position: absolute;
  top: 45px;
  left: 0;
}

</style>
```

### é¡µé¢ç‚¹å‡»äº‹ä»¶æ³¨å†Œä¸æ§åˆ¶åŒºåŸŸ

```js
## æ³¨å†Œæ—¶é—´
// vueåŠ è½½æ—¶å¢åŠ clickäº‹ä»¶
document.querySelector('body').addEventListener('click',this.handleBodyClick)

handleBodyClick(){
  e.stopPropagation()
  // åˆ¤æ–­ç‚¹å‡»åŒºåŸŸä¸åœ¨ icon åŠ modal divåŒºåŸŸå†…ï¼Œåˆ™æ‰§è¡Œå…³é—­çª—å£
  if( !(this.$refs.icons.contains(e.target)||this.$refs.modal.contains(e.target))){
    this.clodeModal()
  }
	
}
// destroyæ—¶ç§»é™¤clickäº‹ä»¶
document.querySelector('body').removeEventListener('click',this.handleBodyClick)
```



### æ­£åˆ™åŒ¹é…æ›¿æ¢æ–‡æœ¬æ¡†å†…å®¹

```js
import faces from '@/assets/js/face'

const htmlEncode = (html) => {
  let temp = document.createElement('div')
  temp.textContent !== undefined ? (temp.textContent = html) : (temp.innerText = html)
  console.log('ğŸš€ ~ file: escapeHtml.js ~ line 6 ~ htmlEncode ~ temp', temp)
  const output = temp.innerHTML
  temp = null
  return output
}
const escapeHtml = (val = '') => {
  if (!val) return ""
  let result = val

  const face = /\sface\[\W{1,}]/g
  const img = /img\[\S+\]/g
  const link = /\sa\(\S+\]/g

  // è¡¨æƒ…æ›¿æ¢
  if (face.test(result)) {
    let group = result.match(face)
    group.map((item) => {
      let key = item.match(/\[\S+\]/g)[0]
      result = result.replace(item, `<img src='${faces[key]}'>`)
    })
  }

  // å›¾ç‰‡æ›¿æ¢
  if (img.test(result)) {
    let group = result.match(img)
    group.map((item) => {
      result = result.replace(item, `<img src='${item.substr(4, item.length - 5)}'>`)
    })
  }

  // é“¾æ¥æ›¿æ¢
  if (link.test(result)) {
    const group = result.match(link)
    const title = /\((.+)\)/
    const linkName = /\[(.+)\]/
    group.map((item) => {
      const namegroup = item.match(linkName)
      let name = ''
      if (namegroup.length > 0) {
        name = namegroup[1]
      }
      const linkgroup = item.match(title)
      let link = ''
      if (namegroup.length > 0) {
        link = linkgroup[1]
      }
      result = result.replace(item,`<a herf='${link}'>${name}</a>`)
    })
  }
  // æ›¿æ¢quote
  result = result.replace(/\[quote\]/g,`<div class='layui-elem-quote'>`)
  result = result.replace(/\[\/quote\]/g,`</div>`)

  // ä»£ç å—æ›¿æ¢
  const code = /(\[\/?pre(.+?)[^\]]*\])|\[[^\]]*\]/g
  if (code.test(result)) {
    const group = result.match(code)
    group.map((item) => {
      result = result.replace(item, htmlEncode(item))
    })
    result = result.replace(/\[pre\]/g, '<pre>')
    result = result.replace(/\[\/pre\]/g, '</pre>')
  }

  // hr æ›¿æ¢
  result = result.replace(/\[hr\]/g, '<hr>')

  // å›æ’¤æ¢è¡Œæ›¿æ¢ä¸ºbr
  result = result.replace(/\n/g, '<br/>')
  result = result.replace(/\r\n\]/g, '<br/>')

  return result
}
// export default
export {
  escapeHtml
}
```



### çˆ¶å­ç»„ä»¶ä¼ è¾“æ•°æ®

```js
## editorç»„ä»¶domå…ƒç´ å‘ç”Ÿå˜åŠ¨ï¼Œä¸Šä¼ editorå†…å®¹
updated () {
    this.$emit('changeContent',this.content)
},
```



```js

## çˆ¶ç»„ä»¶æ¥å—äº‹ä»¶ï¼Œä¿å­˜æ•°æ®
<editor @changeContent="changeContent"></editor>

method(){
	changeContent(val){
		this.content = val
	}
}
```





## ä½¿ç”¨é’©å­å‡½æ•°bind å›å¤å¸–å­å†…å®¹åè¿›è¡Œåˆ·æ–°è°ƒç”¨

> Vue è‡ªå®šä¹‰æŒ‡ä»¤ -  **vueé’©å­å‡½æ•°å®˜æ–¹æ–‡æ¡£**

â€‹	  https://cn.vuejs.org/v2/guide/custom-directive.html#%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0



### [é’©å­å‡½æ•°](https://cn.vuejs.org/v2/guide/custom-directive.html#é’©å­å‡½æ•°)

ä¸€ä¸ªæŒ‡ä»¤å®šä¹‰å¯¹è±¡å¯ä»¥æä¾›å¦‚ä¸‹å‡ ä¸ªé’©å­å‡½æ•° (å‡ä¸ºå¯é€‰)ï¼š

- `bind`ï¼šåªè°ƒç”¨ä¸€æ¬¡ï¼ŒæŒ‡ä»¤ç¬¬ä¸€æ¬¡ç»‘å®šåˆ°å…ƒç´ æ—¶è°ƒç”¨ã€‚åœ¨è¿™é‡Œå¯ä»¥è¿›è¡Œä¸€æ¬¡æ€§çš„åˆå§‹åŒ–è®¾ç½®ã€‚
- `inserted`ï¼šè¢«ç»‘å®šå…ƒç´ æ’å…¥çˆ¶èŠ‚ç‚¹æ—¶è°ƒç”¨ (ä»…ä¿è¯çˆ¶èŠ‚ç‚¹å­˜åœ¨ï¼Œä½†ä¸ä¸€å®šå·²è¢«æ’å…¥æ–‡æ¡£ä¸­)ã€‚
- `update`ï¼šæ‰€åœ¨ç»„ä»¶çš„ VNode æ›´æ–°æ—¶è°ƒç”¨ï¼Œ**ä½†æ˜¯å¯èƒ½å‘ç”Ÿåœ¨å…¶å­ VNode æ›´æ–°ä¹‹å‰**ã€‚æŒ‡ä»¤çš„å€¼å¯èƒ½å‘ç”Ÿäº†æ”¹å˜ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰ã€‚ä½†æ˜¯ä½ å¯ä»¥é€šè¿‡æ¯”è¾ƒæ›´æ–°å‰åçš„å€¼æ¥å¿½ç•¥ä¸å¿…è¦çš„æ¨¡æ¿æ›´æ–° (è¯¦ç»†çš„é’©å­å‡½æ•°å‚æ•°è§ä¸‹)ã€‚

æˆ‘ä»¬ä¼šåœ¨[ç¨å](https://cn.vuejs.org/v2/guide/render-function.html#è™šæ‹Ÿ-DOM)è®¨è®º[æ¸²æŸ“å‡½æ•°](https://cn.vuejs.org/v2/guide/render-function.html)æ—¶ä»‹ç»æ›´å¤š VNodes çš„ç»†èŠ‚ã€‚

- `componentUpdated`ï¼šæŒ‡ä»¤æ‰€åœ¨ç»„ä»¶çš„ VNode **åŠå…¶å­ VNode** å…¨éƒ¨æ›´æ–°åè°ƒç”¨ã€‚
- `unbind`ï¼šåªè°ƒç”¨ä¸€æ¬¡ï¼ŒæŒ‡ä»¤ä¸å…ƒç´ è§£ç»‘æ—¶è°ƒç”¨ã€‚



### ä¼ å‚ï¼š

- `el`ï¼šæŒ‡ä»¤æ‰€ç»‘å®šçš„å…ƒç´ ï¼Œå¯ä»¥ç”¨æ¥ç›´æ¥æ“ä½œ DOMã€‚

- ```
  binding
  ```

  ï¼šä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹ propertyï¼š

  - `name`ï¼šæŒ‡ä»¤åï¼Œä¸åŒ…æ‹¬ `v-` å‰ç¼€ã€‚
  - `value`ï¼šæŒ‡ä»¤çš„ç»‘å®šå€¼ï¼Œä¾‹å¦‚ï¼š`v-my-directive="1 + 1"` ä¸­ï¼Œç»‘å®šå€¼ä¸º `2`ã€‚
  - `oldValue`ï¼šæŒ‡ä»¤ç»‘å®šçš„å‰ä¸€ä¸ªå€¼ï¼Œä»…åœ¨ `update` å’Œ `componentUpdated` é’©å­ä¸­å¯ç”¨ã€‚æ— è®ºå€¼æ˜¯å¦æ”¹å˜éƒ½å¯ç”¨ã€‚
  - `expression`ï¼šå­—ç¬¦ä¸²å½¢å¼çš„æŒ‡ä»¤è¡¨è¾¾å¼ã€‚ä¾‹å¦‚ `v-my-directive="1 + 1"` ä¸­ï¼Œè¡¨è¾¾å¼ä¸º `"1 + 1"`ã€‚
  - `arg`ï¼šä¼ ç»™æŒ‡ä»¤çš„å‚æ•°ï¼Œå¯é€‰ã€‚ä¾‹å¦‚ `v-my-directive:foo` ä¸­ï¼Œå‚æ•°ä¸º `"foo"`ã€‚
  - `modifiers`ï¼šä¸€ä¸ªåŒ…å«ä¿®é¥°ç¬¦çš„å¯¹è±¡ã€‚ä¾‹å¦‚ï¼š`v-my-directive.foo.bar` ä¸­ï¼Œä¿®é¥°ç¬¦å¯¹è±¡ä¸º `{ foo: true, bar: true }`ã€‚

- `vnode`ï¼šVue ç¼–è¯‘ç”Ÿæˆçš„è™šæ‹ŸèŠ‚ç‚¹ã€‚ç§»æ­¥ [VNode API](https://cn.vuejs.org/v2/api/#VNode-æ¥å£) æ¥äº†è§£æ›´å¤šè¯¦æƒ…ã€‚

- `oldVnode`ï¼šä¸Šä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œä»…åœ¨ `update` å’Œ `componentUpdated` é’©å­ä¸­å¯ç”¨ã€‚



> Directives.js

```js
import escapeHtml from "@/utils/escapeHtml"

export default {
  'richtext': {
    bind: function (el, binding, vnode) {
     	## el domå…ƒç´ 
      ## vnode vue è™šæ‹ŸdomèŠ‚ç‚¹
      ## binding ä¼ å…¥èŠ‚ç‚¹
      el.innerHTML = escapeHtml(binding.value)
    }
    ## æ›´æ–°vue ç»„ä»¶dataæ•°æ®ï¼Œdomå…ƒç´ ä¸åˆ·æ–°ï¼Œå› ä¸ºåªä½¿ç”¨äº†bindæ–¹æ³•
    ## æ·»åŠ componentUpdated , dataæ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ‰§è¡ŒcomponentUpdated
    componentUpdated:function (el, binding, vnode) {
     	## el domå…ƒç´ 
      ## vnode vue è™šæ‹ŸdomèŠ‚ç‚¹
      ## binding ä¼ å…¥èŠ‚ç‚¹
      el.innerHTML = escapeHtml(binding.value)
    }
    
  }
}
```

> Main.js

```js
## éå†åŠ è½½ directive 
Object.keys(directives).forEach((key) => {
  Vue.directive(key, directives[key])
})
```



ç¼–è¾‘å›å¤å†…å®¹ï¼Œçª—å£è‡ªåŠ¨æ»šåŠ¨è‡³ç¼–è¾‘å™¨ä½ç½®

Common.js

```js
/******* 
 * @description: 
 * @param {*}
 * @return {*}
 */
const getElementY = (elem) => {
  return window.pageYOffset + document.querySelector(elem).getBoundingClientRect().top
}

/******* 
 * @description: æ»šåŠ¨åˆ°æŒ‡å®šçš„å…ƒç´ 
 * @param {String} elem DOMå…ƒç´ 
 * @param {Number} durction æ»šåŠ¨åŠ¨ç”»æ‰§è¡Œæ—¶é—´
 * @param {Number} offset åç§»é‡
 * @return {*}
 */
const ScrollToElem = (elem, durction, offset) => {
  // åˆå§‹ä½ç½®
  const startingY = window.pageYOffset
  const elementY = getElementY(elem)
  // éœ€è¦æ»šåŠ¨çš„è·ç¦»
  const diff = elementY - startingY + offset
  if (!diff) return
  // æ»‘åŠ¨æ•ˆæœå‡½æ•°
  const easing = t => t < .5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1
  // åˆå§‹åŒ–æ»šåŠ¨æ—¶é—´
  let start
  window.requestAnimationFrame(function step (timestamp) {
    if (!start) start = timestamp
    // è®¡ç®—æ—¶é—´çš„å·®å€¼ï¼Œæ ¹æ®å·®å€¼è®¡ç®—åç§»é‡
    const time = timestamp - start
    let percent = Math.min(time / durction, 1)
    percent = easing(percent)
    window.scrollTo(0, startingY + diff * percent)
    if (time < durction) {
      window.requestAnimationFrame(step)
    }
  })
}

export {
  getElementY, ScrollToElem
}
```

ç›¸å…³é“¾æ¥ï¼š

â€‹	æ»‘åŠ¨å‡½æ•° https://easings.net/

â€‹    Simple Easing  GitHub [https://gist.github.com/gre/1650294]

æµ‹è¯•æ»šåŠ¨ 

```vue
mounted(){
	window.vue = ScrollToElem
}

åç§»é‡ä¸ºTop Panelé«˜åº¦
```

![image-20210706170455891](https://gitee.com/cnmz/images/raw/master/images/20210706170502.png)

